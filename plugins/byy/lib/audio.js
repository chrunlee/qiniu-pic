/*
	@company 博育云
	@site : www.boyuyun.cn
	@author boyuyun
*/

byy.define("jquery",function(a){var b={audios:[],playtime:{}},c={skin:0,music:[],autoplay:!0,showlrc:!1,volume:1,debug:!1,mode:0,onPlay:$.noop,onPause:$.noop,onChange:$.noop,onDestroy:$.noop},d={play:'<i class="byyicon icon-play start-icon" audio-filter="play" {0}></i>',pause:'<i class="byyicon icon-pause start-icon" audio-filter="pause" {0}></i>',volume:'<i class="byyicon icon-volume" audio-filter="clickMuted"></i>',muted:'<i class="byyicon icon-volume-off" audio-filter="clickMuted"></i>',type:['<i class="byyicon icon-play-keep" title="顺序播放"></i>','<i class="byyicon icon-play-single" title="单曲循环"></i>','<i class="byyicon icon-play-loop" title="列表循环"></i>','<i class="byyicon icon-play-random" title="随机播放"></i>']};byy.isMobile()&&(defaults.autoplay=!1);var e={msg:function(a,b){return this.audio("getSettings","debug")&&console.log("%c["+a+"]:%c"+b,"color:green;","color:red"),this},init:function(a){this.audio("setSettings",c),this.audio("msg","init","初始化容器");var d=byy.extend({},c);return"string"==typeof a?(this.audio("msg","init","settings 为 url"),d.music=[this.audio("getMusicByUrl",a)]):(this.audio("msg","init","覆盖默认设置"),d=byy.extend(d,a)),d.id=byy.guid("audio"),this.audio("setSettings",d),this.audio("msg","init","输出当前的配置："+byy.stringfy(d)),b.audios.push(this.$ele),this.audio("render").audio("initEvents"),this},render:function(a){this.audio("msg","render","渲染DOM");var b=this.audio("getSettings");a=a||0;var c=b.music[a];c.url;return"function"==typeof b.onBefore&&b.onBefore.call(this),this.audio("setSettings","playindex",a||0),this.$ele.html(this.audio("getTemplate",c,b)),this.audio("setAudioByMusic",c),b.autoplay?this.audio("play"):this.audio("pause"),this},addMusic:function(a){var a="stirng"==typeof a?this.audio("getMusicByUrl",a):a;if("object"!=typeof a){var b=this.audio("getSettings","music");b.push(a),this.audio("setSettings","music",b),this.audio("msg","addMusic","添加音乐成功")}else this.audio("msg","addMusic","添加的music参数不是对象或者url");return this},parseLrc:function(a){for(var b=a.split("\n"),c=[],d=b.length,e=0;e<d;e++){var f=b[e].match(/\[(\d{2}):(\d{2})\.(\d{2,3})]/g),g=b[e].replace(/\[(\d{2}):(\d{2})\.(\d{2,3})]/g,"").replace(/^\s+|\s+$/g,"");if(f)for(var h=f.length,i=0;i<h;i++){var j=/\[(\d{2}):(\d{2})\.(\d{2,3})]/.exec(f[i]),k=60*j[1]+parseInt(j[2])+parseInt(j[3])/(2===(j[3]+"").length?100:1e3);c.push([k,g])}}return c.sort(function(a,b){return a[0]-b[0]}),c},getLrc:function(a){var b=this,c=[],d="";if(a.startWith("http")){var e="";$.ajax({url:a,type:"GET",success:function(a){e=a,c=b.audio("parseLrc",e),c.length>0&&(b.audio("setSettings","lrc",c),b.audio("setSettings","lrcindex",0),c.forEach(function(a,b){d+='<p time="'+a[0]+'" index="'+b+'">'+a[1]+"</p>"}),b.$ele.find(".byy-player-lrc").html(d))},error:function(a,b){}}),c=b.audio("parseLrc",e)}else{var f=a;try{$(a).length>0&&(f=$(a).html())}catch(a){}c=b.audio("parseLrc",f)}return c.length>0&&(b.audio("setSettings","lrc",c),b.audio("setSettings","lrcindex",0),c.forEach(function(a,b){d+='<p time="'+a[0]+'" index="'+b+'">'+a[1]+"</p>"})),d},updateLrc:function(a){var b=this,c=b.audio("getSettings","audio"),d=b.audio("getSettings","lrc"),e=b.audio("getSettings","lrcindex");if(a=a||c.currentTime,d&&0!=d.length&&(e||0==e)&&(e>d.length-1||a<d[e][0]||!d[e+1]||a>=d[e+1][0]))for(var f=0;f<d.length;f++)a>=d[f][0]&&(!d[f+1]||a<d[f+1][0])&&(b.audio("setSettings","lrcindex",f),b.$ele.find("p.showlrc").removeClass("showlrc"),b.$ele.find(".byy-player-lrc p").eq(f).addClass("showlrc"),b.$ele.find(".byy-player-lrc p").eq(f+1).length>0&&b.$ele.find(".byy-player-lrc p").eq(f+1).addClass("showlrc"))},play:function(){var a=this.audio("getSettings","audio");if(a.paused){a.play(),this.audio("msg","play","开始播放");var b="";this.audio("getSettings","theme")&&(b=' style="background-color:'+this.audio("getSettings","theme")+'"'),this.$ele.find(".byy-player-post").html(byy.formatStr(d.pause,b)),this.audio("startInterval")}},time:function(a){return this.audio("getSettings","audio").currentTime=a,this.audio("msg","time","设置当前时间"+a+"开始播放"),this},toggleList:function(){this.$ele.find(".byy-player-list").toggleClass("show")},updateList:function(a){var b=this,c=b.$ele.find(".byy-player-list");c.find(".selected").removeClass("selected"),c.find(".byy-player-list-block").eq(a).addClass("selected")},clickList:function(a){var b=this;a=a||window.event;var c=a.target||a.srcElement,d=$(c);if(d.length>0){d.parent().find(".selected").removeClass("selected"),d.addClass("selected");var e=d.attr("index");b.audio("next",e)}},toggle:function(a){this.audio("msg","toggle","切换播放状态");var b=this.audio("getSettings","audio"),c=b.paused;a=void 0==a||null==a?c:a,a?this.audio("play"):this.audio("pause")},pause:function(){var a=this.audio("getSettings","audio"),b="";this.audio("getSettings","theme")&&(b=' style="background-color:'+this.audio("getSettings","theme")+'"'),this.$ele.find(".byy-player-post").html(byy.formatStr(d.play,b)),a.paused||(a.pause(),this.audio("msg","pause","暂停播放"),this.audio("getSettings","onPause").apply(this),this.audio("stopInterval"))},next:function(a){var b=this;b.audio("msg","next","切换到下一首进行播放");var c=b.audio("getSettings"),e=c.audio,f=c.mode,g=c.music,h=c.playindex;if(a)e.ended||(console.log("-------------preload下切歌"),b.audio("setSettings","audio",null));else switch(f){case 0:a=h>=g.length-1?-1:h+1;break;case 1:a=h;break;case 2:a=h>=g.length-1?0:h+1;break;case 3:a=1==g.length?0:Math.round(Math.random()*(g.length-1))}if(a>-1)b.$ele.trigger("next",[g[a],a]),b.audio("render",a),b.audio("startInterval");else{var e=b.audio("getSettings","audio");this.$ele.find(".byy-player-post").html(d.play),this.audio("getSettings","onPause").apply(this)}},clickPercent:function(a){a=a||window.event;var b=this,c=b.$ele.find(".byy-player-progress-bar"),d=b.audio("getSettings","audio"),e=(a.clientX-c.offset().left)/c.width();isNaN(d.duration)&&(e=0),e=Math.max(e,0),e=Math.min(e,1),b.audio("updatePercent","progress",e),b.audio("msg","clickPercent","更新进度条"),b.audio("updateTime",e*b.audio("getSettings","audio").duration)},clickMuted:function(){this.audio("msg","clickMuted","点击音量图标");var a=this,b=a.audio("getSettings","audio");a.audio("setMuted",!b.muted)},setMuted:function(a){this.audio("msg","setMuted","设置静音"+a);var b=this,c=b.audio("getSettings","audio");c.muted=a,b.$ele.find('[audio-filter="clickMuted"]').removeClass(c.muted?"icon-volume":"icon-volume-off").addClass(c.muted?"icon-volume-off":"icon-volume")},setAudioByMusic:function(a){var b=this;b.audio("msg","setAudioByMusic","根据music设置audio信息");var c=b.audio("getSettings","audio"),d=(b.audio("getSettings","autoplay"),b.audio("getSettings","preload")),e=b.audio("getSettings","volume");c=c||document.createElement("audio");try{c.src=a.url}catch(a){console.log(a)}return c.controls=!1,c.autoplay=!1,c.volume=e>1?1:e<0?0:e,0==c.volume&&(c.muted=!0),c.preload=d||"auto",c.onplay=function(){b.$ele.trigger("play")},c.onprogress=function(){b.$ele.trigger("progress")},c.oncanplay=function(){b.$ele.trigger("canplay")},c.onended=function(){b.$ele.trigger("onEnded")},c.ondurationchange=function(){b.$ele.trigger("durationchange")},c.onerror=function(a){console.log(a)},b.audio("setSettings","audio",c),this},updateTime:function(a){a&&(this.audio("msg","updateTime","更新时间"+a),this.audio("time",a));var b=this.audio("getSettings","audio");a=a||b.currentTime;var c=b.duration,d=function(a){if(isNaN(a))return"00:00";var b=function(a){return a<10?"0"+a:""+a},c=parseInt(a/60),d=parseInt(a-60*c),e=parseInt(c/60),f=parseInt(a/60-60*parseInt(a/60/60));return a>=3600?b(e)+":"+b(f)+":"+b(d):b(c)+":"+b(d)},e=d(a),f=d(c);this.$ele.find(".left-time").html(e),this.$ele.find(".right-time").html(f),this.audio("getSettings","showlrc")&&this.audio("updateLrc",a)},updateProgress:function(a){this.audio("msg","updateProgress","当前缓存进度"+a),a=a||0,a=Math.max(a,0),a=Math.min(a,1),this.$ele.find(".byy-player-progress-down").css("width",100*a+"%")},updatePercent:function(a,b){var b=b||0;b=b>1?1:b<0?0:b,b=(100*b).toFixed(2),this.$ele.find(".byy-player-progress-left").css("width",b+"%")},startInterval:function(){this.audio("msg","startInterval","开启进度条更新");var a=this,c=a.audio("getSettings"),d=c.id;b.playtime[d]&&clearInterval(b.playtime[d]),b.playtime[d]=setInterval(function(){var b=a.audio("getSettings","audio"),c=b.currentTime/b.duration;a.audio("updatePercent","progress",c),a.audio("updateTime"),a.$ele.trigger("playing")},300)},stopInterval:function(){var a=this;a.audio("msg","stopInterval","取消进度条更新");var c=a.audio("getSettings"),d=c.id;clearInterval(b.playtime[d])},initEvents:function(){var a=this;a.audio("msg","initEvents","初始化事件"),a.$ele.on("click","[audio-filter]",function(b){var c=$(this).attr("audio-filter");a.audio("msg","audio-filter","点击触发："+c),c&&e[c]&&a.audio(c,b)}),a.$ele.on("next",function(b,c,d){a.audio("msg","onChange","切换下一首歌曲"+c.title);var e=a.audio("getSettings");"function"==typeof e.onChange&&e.onChange.call(a,c)}),a.$ele.on("progress",function(){a.audio("msg","progress","加载音频缓存");var b=a.audio("getSettings","audio"),c=b.buffered.length?b.buffered.end(b.buffered.length-1)/b.duration:0;a.audio("updateProgress",c)}),a.$ele.on("play",function(){a.audio("msg","event:play","开始播放");var b=a.audio("getSettings");"function"==typeof b.onPlay&&b.onPlay.call(a)}),a.$ele.on("playing",function(){var b=a.audio("getSettings");"function"==typeof b.onPlaying&&b.onPlaying.call(a)}),a.$ele.on("durationchange",function(){var b=a.audio("getSettings","audio");a.audio("msg","durationchange","当前音频时长变化"+b.duration),1!==b.duration&&a.audio("updateTime",0)}),a.$ele.on("updateVolume",function(b,c){a.audio("msg","updateVolume","更新音量"+c);var d=a.audio("getSettings");"function"==typeof d.onVolume&&d.onVolume.call(a,c)}),a.$ele.on("canplay",function(){a.audio("startInterval");var b=a.audio("getSettings");a.audio("msg","canplay","当前音频已就绪，可以播放"),"function"==typeof b.onCanplay&&b.onCanplay.call(a)}),a.$ele.on("onEnded",function(b){a.audio("msg","onEnded","播放结束");var c=a.audio("getSettings");"function"==typeof c.onEnded&&c.onEnded.call(a),a.audio("stopInterval"),a.audio("next")});var b=function(b){b=b||window.event;var c=(b.clientX-a.$ele.find(".byy-player-progress").offset().left)/a.$ele.find(".byy-player-progress").width();c=c>0?c:0,c=c<1?c:1,a.audio("updatePercent","progress",c),a.audio("getSettings","showlrc"),a.audio("setSettings","movetime",c*a.audio("getSettings","audio").duration)},c=function(){$(document).off("mousemove",b),$(document).off("mouseup",c),a.audio("updateTime",a.audio("getSettings","movetime")),a.audio("startInterval")};a.$ele.on("mousedown",".byy-player-progress-dot",function(d){a.audio("stopInterval"),$(document).off("mousemove",b).on("mousemove",b),$(document).off("mouseup",c).on("mouseup",c)})},getTemplate:function(a,b){this.audio("msg","getTemplate","获得DOM模版内容");var c=a.post?'style="background-image:url('+a.post+')"':"",e='<div class="byy-player-lrc">';if(b.showlrc&&a.lrc){e+=this.audio("getLrc",a.lrc)}e+="</div>";var f="",g="",h="";b.theme&&(f=' style="border-color:'+b.theme+'" ',' style="color:'+b.theme+'"',g=' style="background-color:'+b.theme+'"',h="background-color:"+b.theme+";");var i="",j=this.audio("getSettings","playindex");return b.music.length>1&&b.music.forEach(function(a,b){var c=a.title;i+='<div class="byy-player-list-block '+(b===parseInt(j,10)?"selected":"")+'" index="'+b+'" audio-filter="clickList">'+c+"</div>"}),'<div class="byy-player" '+f+'><div class="byy-player-post" '+c+'><i class="byyicon icon-play" audio-filter="play" '+g+'></i></div><div class="byy-player-info"><div class="byy-player-title"><span class="title">'+a.title+'</span><span class="author">'+a.author+"</span></div>"+e+'<div class="byy-player-control"><div class="byy-player-progress" audio-filter="clickPercent"><div class="byy-player-progress-bar"><div class="byy-player-progress-down"></div></div><div class="byy-player-progress-left" '+g+'><span class="byy-player-progress-dot" '+f+'></span></div></div><div class="byy-player-right"><div class="byy-player-time"><span class="left-time"></span>/<span class="right-time"></span></div><div class="byy-player-volume">'+(b.volume<=0?byy.formatStr(d.muted,""):byy.formatStr(d.volume,""))+'<div class="byy-player-volume-select" audio-filter="clickVolume" '+f+'><div class="byy-player-volume-now" style="height:'+(100*b.volume>100?100:100*b.volume<0?0:100*b.volume)+"%;"+h+'"></div></div></div><div class="byy-player-type" audio-filter="changeMode">'+byy.formatStr(d.type[b.mode],"")+'</div><div class="byy-player-list-icon" audio-filter="toggleList"><i class="byyicon icon-list"></i></div></div></div></div><div class="byy-player-list">'+i+"</div></div>"},clickVolume:function(a){var b=this;b.audio("msg","clickVolume","点击音量区域");var c=b.$ele.find(".byy-player-volume-select"),d=c.offset().top,e=c.height(),f=a.clientY,g=(Math.abs(f-(d+e))/e).toFixed(1);g=g>1?1:g<.1?0:g;var h=100*g+"%";c.find(".byy-player-volume-now").css("height",h),b.audio("updateVolume",g)},updateVolume:function(a){var b=this;b.audio("msg","updateVolume","更新音量信息"+a),a=a>1?1:a<0?0:a,this.audio("getSettings","audio").volume=a,b.audio("setMuted",0===a),b.$ele.trigger("updateVolume",[a])},changeMode:function(){var a=this,b=a.audio("getSettings","mode"),c=parseInt(b,10)+1;c=c>3?0:c,a.audio("msg","changeMode","变更播放模式"+c),a.audio("setSettings","mode",c);var e="";a.audio("getSettings","theme")&&(e=' style="color:'+a.audio("getSettings","theme")+'"'),a.$ele.find(".byy-player-type").html(byy.formatStr(d.type[c],e))},setSettings:function(a){if("string"==typeof a){var b=this.audio("getSettings"),c=Array.prototype.slice.call(arguments,1);b[a]=c[0],this.audio("msg","setSettings","设置参数"+a+"成功"),this.$ele.data("settings",b)}else this.$ele.data("settings",a),this.audio("msg","setSettings","设置参数到DOM");return this},getSettings:function(a){var b=this.$ele.data("settings");return b?a?b[a]:b:defaults},getMusicByUrl:function(a){var b=a.substring(a.lastIndexOf("/")+1);return this.audio("msg","getMusicByUrl","获得名称"+b),{author:"",title:b,url:a,lrc:"",post:""}}};byy.fn.extend(byy.fn,{audio:function(a){return e[a]?e[a].apply(this,Array.prototype.slice.call(arguments,1)):"object"==typeof a||a?e.init.apply(this,arguments):void byy.error("Method with name "+a+" does not exists for audio")}}),a("audio",{version:"1.0",tip:"仅支持HTML5浏览器"})});